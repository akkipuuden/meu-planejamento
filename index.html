<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Meu Planejamento Pessoal</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Meu Planejamento">
<link rel="apple-touch-icon" href="https://img.icons8.com/color/144/calendar--v1.png">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS BASE --- */
        :root {
            --primary: #4f46e5;
            --primary-soft: #e0e7ff;
            --secondary: #f59e0b;
            --secondary-soft: #fef3c7;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --danger: #ef4444;
            --success: #10b981;
            --nav-height: 70px;
            --radius: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            display: flex; 
            justify-content: center; 
            height: 100vh;
            overflow: hidden;
        }

        /* --- MOLDURA DO APP --- */
        #app-frame {
            width: 100%;
            max-width: 480px;
            background: #f8fafc;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* --- HEADER --- */
        header { 
            background: white;
            padding: 1rem 1.5rem; 
            z-index: 20; 
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        h1 { font-size: 1.2rem; font-weight: 800; color: var(--primary); }
        #header-date { font-size: 0.8rem; color: var(--text-muted); font-weight: 500; text-transform: capitalize; }

        /* --- √ÅREA DE CONTE√öDO --- */
        main {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 90px;
            scroll-behavior: smooth;
        }
        main::-webkit-scrollbar { width: 4px; }
        main::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }

        /* --- VIEWS --- */
        .view { display: none; padding: 1.5rem; animation: fadeIn 0.3s ease-out; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        h2 { font-size: 1.2rem; margin-bottom: 1rem; color: var(--text-main); font-weight: 700; }

        /* --- ELEMENTOS FLUTUANTES --- */
        .bottom-nav { 
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: white; height: var(--nav-height); 
            display: flex; justify-content: space-around; align-items: center; 
            box-shadow: 0 -1px 10px rgba(0,0,0,0.05); border-top: 1px solid #f1f5f9;
            z-index: 50;
        }

        .fab-btn {
            position: absolute; bottom: 85px; right: 20px;
            background: var(--primary); color: white;
            width: 56px; height: 56px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
            border: none; cursor: pointer; z-index: 60;
            transition: transform 0.2s;
        }
        .fab-btn:active { transform: scale(0.9); }

        /* --- COMPONENTES VISUAIS --- */
        .card { 
            background: var(--bg-card); padding: 1.5rem; border-radius: var(--radius); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); margin-bottom: 1rem; border: 1px solid #e2e8f0;
        }

        /* Calend√°rio */
        .calendar-controls { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 1.2rem; background: white; padding: 0.5rem; 
            border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .calendar-month-title { font-weight: 700; font-size: 1rem; text-transform: capitalize; }
        .btn-icon { background: transparent; border: none; cursor: pointer; color: var(--text-main); padding: 5px; border-radius: 8px; }
        .btn-icon:hover { background: #f1f5f9; }
        .btn-today { font-size: 0.75rem; color: var(--primary); font-weight: 600; cursor: pointer; padding: 5px 10px; background: var(--primary-soft); border-radius: 8px; border: none; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .cal-header { font-size: 0.7rem; font-weight: 600; color: #94a3b8; text-align: center; margin-bottom: 5px; }
        
        .cal-day {
            background: white; border-radius: 12px; min-height: 80px; padding: 6px;
            display: flex; flex-direction: column; cursor: pointer; border: 1px solid transparent;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03); transition: all 0.2s;
        }
        .cal-day:active { transform: scale(0.95); }
        .cal-day.today { border-color: var(--primary); background: #f8fafc; }
        .day-number { font-size: 0.8rem; font-weight: 600; margin-bottom: 4px; text-align: center; color: var(--text-muted); }
        .cal-day.today .day-number { color: var(--primary); background: var(--primary-soft); border-radius: 50%; width: 24px; height: 24px; display: flex; justify-content: center; align-items: center; margin: 0 auto 4px auto; }

        .dot-container { display: flex; justify-content: center; gap: 3px; flex-wrap: wrap; }
        .dot { width: 6px; height: 6px; border-radius: 50%; }
        .dot.event { background: var(--primary); }
        .dot.routine { background: var(--secondary); }

        /* Listas e Itens */
        .list-container { display: flex; flex-direction: column; gap: 0.8rem; }
        .task-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 1rem; background: white; border-radius: 12px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-left: 4px solid transparent;
            transition: opacity 0.3s;
        }
        .task-row.event { border-left-color: var(--primary); }
        .task-row.routine { border-left-color: var(--secondary); }
        .task-time { font-weight: 700; font-size: 0.9rem; margin-right: 10px; min-width: 45px; }
        
        /* Checkbox Customizado */
        .task-check { width: 22px; height: 22px; cursor: pointer; accent-color: var(--primary); }
        .task-row.routine .task-check { accent-color: var(--secondary); }

        /* Finan√ßas */
        .fin-grid { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        .fin-box { flex: 1; background: white; padding: 1rem; border-radius: 12px; text-align: center; border: 1px solid #e2e8f0; }
        .fin-val { display: block; font-size: 1.1rem; font-weight: 700; margin-top: 5px; }
        .income { color: var(--success); }
        .expense { color: var(--danger); }

        /* Navega√ß√£o */
        .nav-item { 
            background: none; border: none; display: flex; flex-direction: column; 
            align-items: center; color: #94a3b8; font-size: 0.7rem; cursor: pointer; 
            width: 100%; transition: color 0.2s;
        }
        .nav-item.active { color: var(--primary); }
        .nav-item span.material-icons-round { font-size: 1.6rem; margin-bottom: 4px; }

        /* Modais */
        .modal { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: flex-end; backdrop-filter: blur(2px); }
        
        .modal-content { 
            background: white; padding: 1.5rem; 
            border-radius: 24px 24px 0 0; width: 100%; 
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 90%; display: flex; flex-direction: column;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .modal-fullscreen { align-items: center; }
        .modal-fullscreen .modal-content { 
            height: 100%; max-height: 100%; border-radius: 0; padding: 0; background: #f8fafc;
        }

        .day-view-header { background: white; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 5px rgba(0,0,0,0.05); }
        .day-view-body { padding: 1.5rem; overflow-y: auto; flex: 1; }

        /* Forms */
        input:not([type="checkbox"]), select { width: 100%; padding: 1rem; margin-bottom: 1rem; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 1rem; background: #f8fafc; outline: none; }
        .row { display: flex; gap: 10px; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 1rem; border-radius: 12px; width: 100%; font-weight: 600; cursor: pointer; }
        .btn-secondary { background: white; border: 1px solid #cbd5e1; color: var(--text-muted); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; }

        .del-btn { background: none; border: none; color: #cbd5e1; cursor: pointer; padding: 5px; }
        .del-btn:hover { color: var(--danger); }

        #toast { 
            position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); 
            background: #1e293b; color: white; padding: 10px 20px; 
            border-radius: 30px; z-index: 200; font-size: 0.9rem; 
            opacity: 0; transition: opacity 0.3s; pointer-events: none; width: max-content;
        }
        #toast.visible { opacity: 1; }

    </style>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Meu Planejamento">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/144/calendar--v1.png">
</head>
<body>

    <div id="app-frame">
        <header>
            <h1>Meu Planejamento</h1>
            <div id="header-date"></div>
        </header>

        <main>
            <section id="dashboard" class="view active">
                <div class="card" style="background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%); color: white; border: none; text-align: center; padding: 2rem;">
                    <span style="opacity: 0.9; font-size: 0.9rem;">Saldo Atual</span>
                    <h1 id="dash-balance" style="font-size: 2.5rem; margin: 5px 0; color: white;">R$ 0,00</h1>
                </div>

                <h2 style="font-size: 1rem; margin-top: 1.5rem;">Tarefas de Hoje</h2>
                <div id="dash-tasks-list" class="list-container"></div>
            </section>

            <section id="calendar" class="view">
                <div class="calendar-controls">
                    <button class="btn-icon" onclick="changeMonth(-1)"><span class="material-icons-round">chevron_left</span></button>
                    <div style="text-align:center">
                        <div id="calendar-month-title" class="calendar-month-title"></div>
                        <button class="btn-today" onclick="goToToday()">Ir para Hoje</button>
                    </div>
                    <button class="btn-icon" onclick="changeMonth(1)"><span class="material-icons-round">chevron_right</span></button>
                </div>

                <div class="calendar-grid" id="calendar-grid">
                    <div class="cal-header">D</div><div class="cal-header">S</div><div class="cal-header">T</div><div class="cal-header">Q</div><div class="cal-header">Q</div><div class="cal-header">S</div><div class="cal-header">S</div>
                    </div>

                <div style="margin-top: 20px; display: flex; justify-content: center; gap: 15px; font-size: 0.75rem; color: var(--text-muted);">
                    <div style="display:flex; align-items:center; gap:5px;"><div class="dot event"></div> Evento</div>
                    <div style="display:flex; align-items:center; gap:5px;"><div class="dot routine"></div> Rotina</div>
                </div>
            </section>

            <section id="metrics" class="view">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <h2>Rotina Di√°ria</h2>
                    <button class="btn-secondary" onclick="openModal('metrics-config-modal')">Configurar</button>
                </div>
                <div id="metrics-list" class="list-container"></div>
            </section>

            <section id="finance" class="view">
                <div class="fin-grid">
                    <div class="fin-box">
                        <small style="color:#64748b">Entradas</small>
                        <span id="fin-income" class="fin-val income">R$ 0,00</span>
                    </div>
                    <div class="fin-box">
                        <small style="color:#64748b">Sa√≠das</small>
                        <span id="fin-expense" class="fin-val expense">R$ 0,00</span>
                    </div>
                </div>

                <h2>Transa√ß√µes</h2>
                <div id="transaction-list" class="list-container"></div>
                
                <button class="fab-btn" onclick="openModal('transaction-modal')">
                    <span class="material-icons-round">add</span>
                </button>
            </section>
        </main>

        <nav class="bottom-nav">
            <button class="nav-item active" onclick="navigate('dashboard')">
                <span class="material-icons-round">dashboard</span>
                <span>In√≠cio</span>
            </button>
            <button class="nav-item" onclick="navigate('calendar')">
                <span class="material-icons-round">calendar_month</span>
                <span>Agenda</span>
            </button>
            <button class="nav-item" onclick="navigate('metrics')">
                <span class="material-icons-round">check_circle</span>
                <span>Rotina</span>
            </button>
            <button class="nav-item" onclick="navigate('finance')">
                <span class="material-icons-round">attach_money</span>
                <span>Finan√ßas</span>
            </button>
        </nav>
        
        <div id="toast">Notifica√ß√£o</div>

        <div id="day-view-modal" class="modal modal-fullscreen">
            <div class="modal-content">
                <div class="day-view-header">
                    <button class="btn-icon" onclick="closeModal('day-view-modal')"><span class="material-icons-round">arrow_back</span></button>
                    <h3 id="day-view-title" style="font-size:1rem; text-transform:capitalize">Data</h3>
                    <div style="width:36px"></div>
                </div>
                <div class="day-view-body">
                    <div id="day-view-list" class="list-container"></div>
                </div>
                <button class="fab-btn" onclick="openEventModalFromDayView()">
                    <span class="material-icons-round">add</span>
                </button>
            </div>
        </div>

        <div id="event-modal" class="modal">
            <div class="modal-content">
                <div style="display:flex; justify-content:space-between; margin-bottom:1rem">
                    <h3>Novo Evento</h3>
                    <button class="btn-icon" onclick="closeModal('event-modal')"><span class="material-icons-round">close</span></button>
                </div>
                <input type="text" id="event-title" placeholder="T√≠tulo">
                <input type="date" id="event-date">
                <div class="row">
                    <input type="time" id="event-start">
                    <input type="time" id="event-end">
                </div>
                <button class="btn-primary" onclick="addEvent()">Salvar</button>
            </div>
        </div>

        <div id="transaction-modal" class="modal">
            <div class="modal-content">
                <div style="display:flex; justify-content:space-between; margin-bottom:1rem">
                    <h3>Nova Transa√ß√£o</h3>
                    <button class="btn-icon" onclick="closeModal('transaction-modal')"><span class="material-icons-round">close</span></button>
                </div>
                <select id="trans-type">
                    <option value="expense">Sa√≠da (-)</option>
                    <option value="income">Entrada (+)</option>
                </select>
                <input type="text" id="trans-desc" placeholder="Descri√ß√£o">
                <input type="number" id="trans-value" placeholder="Valor" step="0.01">
                <input type="text" id="trans-cat" placeholder="Categoria">
                <button class="btn-primary" onclick="addTransaction()">Salvar</button>
            </div>
        </div>

        <div id="metrics-config-modal" class="modal">
            <div class="modal-content">
                <div style="display:flex; justify-content:space-between; margin-bottom:1rem">
                    <h3>Configurar Rotina</h3>
                    <button class="btn-icon" onclick="closeModal('metrics-config-modal')"><span class="material-icons-round">close</span></button>
                </div>
                <div class="row">
                    <input type="text" id="new-metric-title" placeholder="Atividade">
                    <input type="time" id="new-metric-time">
                </div>
                <button class="btn-primary" onclick="createNewMetricTemplate()" style="margin-bottom:1.5rem">Adicionar</button>
                <ul id="metric-template-list" style="list-style:none; padding:0; font-size:0.9rem;"></ul>
            </div>
        </div>

    </div> <script>
        // --- JAVASCRIPT ---
        const APP_KEY = 'my_planner_v6_final';
        let viewDate = new Date();
        let selectedDateStr = '';
        
        let data = {
            events: [], metricsTemplates: [], dailyMetrics: {}, transactions: []
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            updateHeaderDate();
            navigate('dashboard');
            setInterval(checkNotifications, 30000);
            
            if(data.metricsTemplates.length === 0) {
                data.metricsTemplates = [
                    { id: 1, title: 'Acordar', time: '07:00' },
                    { id: 2, title: 'Dormir', time: '23:00' }
                ];
            }
        });

        function saveData() {
            localStorage.setItem(APP_KEY, JSON.stringify(data));
            refreshCurrentView();
        }

        function loadData() {
            const stored = localStorage.getItem(APP_KEY);
            if (stored) try { data = JSON.parse(stored); } catch(e) {}
        }

        function refreshCurrentView() {
            if(document.getElementById('dashboard').classList.contains('active')) renderDashboard();
            if(document.getElementById('calendar').classList.contains('active')) renderCalendar();
            if(document.getElementById('metrics').classList.contains('active')) renderMetrics();
            if(document.getElementById('finance').classList.contains('active')) renderFinance();
            if(document.getElementById('day-view-modal').style.display === 'flex') openDayDetails(selectedDateStr);
        }

        function updateHeaderDate() {
            const options = { weekday: 'short', day: 'numeric', month: 'long' };
            document.getElementById('header-date').innerText = new Date().toLocaleDateString('pt-BR', options);
        }

        function navigate(viewId) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            const map = { 'dashboard': 0, 'calendar': 1, 'metrics': 2, 'finance': 3 };
            const navs = document.querySelectorAll('.nav-item');
            if(navs[map[viewId]]) navs[map[viewId]].classList.add('active');
            refreshCurrentView();
        }

        // --- DASHBOARD ATUALIZADO (Com Checkbox) ---
        function renderDashboard() {
            let bal = 0; data.transactions.forEach(t => bal += t.type === 'income' ? parseFloat(t.amount) : -parseFloat(t.amount));
            document.getElementById('dash-balance').innerText = `R$ ${bal.toFixed(2)}`;

            const list = document.getElementById('dash-tasks-list');
            list.innerHTML = '';
            
            const today = new Date().toISOString().split('T')[0];
            
            // Eventos
            const evs = data.events.filter(e => e.dateString === today).map(e=>({...e, type:'event', done: e.completed || false }));
            // Rotinas
            const ruts = data.metricsTemplates.map(t => {
                const isDone = (data.dailyMetrics[today] && data.dailyMetrics[today][t.id]) ? data.dailyMetrics[today][t.id].done : false;
                return {...t, type:'routine', done: isDone};
            });

            const all = [...evs, ...ruts].sort((a,b)=>a.time.localeCompare(b.time));

            if(all.length===0) list.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:1rem">Tudo feito! üéâ</div>';
            else all.forEach(i => {
                const div = document.createElement('div');
                div.className = `task-row ${i.type}`;
                div.style.padding = '1rem'; 
                div.style.opacity = i.done ? '0.6' : '1';
                
                div.innerHTML = `
                    <div style="display:flex; align-items:center; flex:1">
                        <span class="task-time" style="color:var(${i.type==='event'?'--primary':'--secondary'})">${i.time}</span>
                        <span class="task-title" style="${i.done ? 'text-decoration:line-through' : ''}">${i.title}</span>
                    </div>
                    <input type="checkbox" class="task-check" ${i.done ? 'checked' : ''} onchange="toggleDashTask('${i.type}', ${i.id}, this.checked)">
                `;
                list.appendChild(div);
            });
        }

        // Nova fun√ß√£o para check no dashboard
        function toggleDashTask(type, id, isChecked) {
            const today = new Date().toISOString().split('T')[0];
            if(type === 'event') {
                const ev = data.events.find(e => e.id === id);
                if(ev) ev.completed = isChecked;
            } else {
                if(!data.dailyMetrics[today]) data.dailyMetrics[today] = {};
                if(!data.dailyMetrics[today][id]) data.dailyMetrics[today][id] = {};
                data.dailyMetrics[today][id].done = isChecked;
            }
            saveData();
        }

        // --- CALEND√ÅRIO ---
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            while(grid.children.length > 7) grid.removeChild(grid.lastChild);

            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            document.getElementById('calendar-month-title').innerText = viewDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

            const firstDayIndex = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const todayStr = new Date().toISOString().split('T')[0];

            for (let i = 0; i < firstDayIndex; i++) grid.appendChild(document.createElement('div'));

            for (let d = 1; d <= daysInMonth; d++) {
                const cell = document.createElement('div');
                cell.className = 'cal-day';
                const dateStr = `${year}-${String(month+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                if (dateStr === todayStr) cell.classList.add('today');

                let html = `<div class="day-number">${d}</div><div class="dot-container">`;
                if(data.events.some(e => e.dateString === dateStr)) html += `<div class="dot event"></div>`;
                if(data.metricsTemplates.length > 0) html += `<div class="dot routine"></div>`;
                html += `</div>`;
                
                cell.innerHTML = html;
                cell.onclick = () => openDayDetails(dateStr);
                grid.appendChild(cell);
            }
        }
        function changeMonth(d) { viewDate.setMonth(viewDate.getMonth() + d); renderCalendar(); }
        function goToToday() { viewDate = new Date(); renderCalendar(); }

        // --- DETALHES DO DIA ---
        function openDayDetails(dateStr) {
            selectedDateStr = dateStr;
            const container = document.getElementById('day-view-list');
            container.innerHTML = '';
            
            const [y, m, d] = dateStr.split('-');
            const dateObj = new Date(y, m-1, d);
            document.getElementById('day-view-title').innerText = dateObj.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });

            const events = data.events.filter(e => e.dateString === dateStr).map(e => ({...e, type: 'event', done: e.completed || false}));
            const routines = data.metricsTemplates.map(tpl => {
                const done = (data.dailyMetrics[dateStr] && data.dailyMetrics[dateStr][tpl.id]) ? data.dailyMetrics[dateStr][tpl.id].done : false;
                return { ...tpl, type: 'routine', done, dateString: dateStr };
            });

            const all = [...events, ...routines].sort((a,b) => a.time.localeCompare(b.time));

            if (all.length === 0) container.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:2rem">Nada hoje.</div>';
            else {
                all.forEach(item => {
                    const el = document.createElement('div');
                    el.className = `task-row ${item.type}`;
                    el.style.opacity = item.done ? '0.6' : '1';
                    
                    let htmlContent = `
                        <div style="flex:1; display:flex; align-items:center;">
                            <span class="task-time" style="color:var(${item.type === 'event' ? '--primary' : '--secondary'})">${item.time}</span>
                            <span class="task-title" style="${item.done ? 'text-decoration:line-through' : ''}">${item.title}</span>
                        </div>
                    `;

                    if(item.type === 'event') {
                         htmlContent += `
                            <input type="checkbox" class="task-check" style="margin-right:10px" ${item.done ? 'checked' : ''} onchange="toggleDashTask('event', ${item.id}, this.checked)">
                            <button class="del-btn" onclick="deleteEvent(${item.id})"><span class="material-icons-round">delete</span></button>
                        `;
                    } else {
                        htmlContent += `
                            <input type="checkbox" class="task-check" ${item.done ? 'checked' : ''} onchange="toggleDashTask('routine', ${item.id}, this.checked)">
                        `;
                    }
                    
                    el.innerHTML = htmlContent;
                    container.appendChild(el);
                });
            }
            openModal('day-view-modal');
        }

        function openEventModalFromDayView() {
            document.getElementById('event-date').value = selectedDateStr;
            document.getElementById('event-title').value = '';
            document.getElementById('event-start').value = '';
            document.getElementById('event-end').value = '';
            openModal('event-modal');
        }

        // --- L√ìGICA DE DADOS ---
        function addEvent() {
            const title = document.getElementById('event-title').value;
            const dateStr = document.getElementById('event-date').value;
            const start = document.getElementById('event-start').value;
            const end = document.getElementById('event-end').value;

            if(!title || !dateStr || !start) return showToast('Preencha os campos');
            
            data.events.push({ id: Date.now(), title, dateString: dateStr, time: start, completed: false });
            saveData();
            closeModal('event-modal');
            
            if(confirm('Evento salvo! Adicionar ao Calend√°rio do iPhone?')) {
                downloadICS(title, dateStr, start, end);
            } else {
                showToast('Evento criado');
            }
        }

        function deleteEvent(id) {
            if(confirm('Excluir?')) { data.events = data.events.filter(e => e.id !== id); saveData(); }
        }

        function renderMetrics() {
            const list = document.getElementById('metrics-list');
            list.innerHTML = '';
            const today = new Date().toISOString().split('T')[0];
            
            data.metricsTemplates.sort((a,b) => a.time.localeCompare(b.time)).forEach(tpl => {
                const isDone = (data.dailyMetrics[today] && data.dailyMetrics[today][tpl.id]) ? data.dailyMetrics[today][tpl.id].done : false;
                const div = document.createElement('div');
                div.className = 'task-row routine';
                div.style.opacity = isDone ? '0.6' : '1';
                div.innerHTML = `
                    <div style="flex:1;">
                        <span class="task-time" style="color:var(--secondary)">${tpl.time}</span>
                        <span class="task-title" style="${isDone?'text-decoration:line-through':''}">${tpl.title}</span>
                    </div>
                    <input type="checkbox" class="task-check" ${isDone ? 'checked' : ''} onchange="toggleDashTask('routine', ${tpl.id}, this.checked)">
                `;
                list.appendChild(div);
            });

            const configList = document.getElementById('metric-template-list');
            configList.innerHTML = '';
            data.metricsTemplates.forEach(t => {
                const li = document.createElement('li');
                li.style.padding='8px 0'; li.style.borderBottom='1px solid #f1f5f9'; li.style.display='flex'; li.style.justifyContent='space-between';
                li.innerHTML = `<span>${t.time} - ${t.title}</span> <span style="color:red; cursor:pointer" onclick="deleteMetricTpl(${t.id})">√ó</span>`;
                configList.appendChild(li);
            });
        }
        function createNewMetricTemplate() {
            const title = document.getElementById('new-metric-title').value;
            const time = document.getElementById('new-metric-time').value;
            if(title && time) { data.metricsTemplates.push({id:Date.now(), title, time}); saveData(); document.getElementById('new-metric-title').value='';}
        }
        function deleteMetricTpl(id) { data.metricsTemplates = data.metricsTemplates.filter(t=>t.id!==id); saveData(); }

        function renderFinance() {
            const list = document.getElementById('transaction-list');
            list.innerHTML = '';
            let inc = 0, exp = 0;
            const sorted = [...data.transactions].sort((a,b) => new Date(b.date) - new Date(a.date));

            if(sorted.length === 0) list.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:2rem">Sem transa√ß√µes.</div>';
            else {
                sorted.forEach(t => {
                    const val = parseFloat(t.amount);
                    if(t.type === 'income') inc += val; else exp += val;
                    const div = document.createElement('div');
                    div.className = 'task-row';
                    div.innerHTML = `
                        <div style="flex:1">
                            <strong style="display:block; font-size:0.9rem">${t.desc}</strong>
                            <small style="color:#94a3b8">${t.category}</small>
                        </div>
                        <span class="${t.type}" style="font-weight:700">${t.type==='income'?'+':'-'} R$ ${val.toFixed(2)}</span>
                        <button class="del-btn" onclick="delTrans(${t.id})"><span class="material-icons-round">delete</span></button>
                    `;
                    list.appendChild(div);
                });
            }
            document.getElementById('fin-income').innerText = `R$ ${inc.toFixed(2)}`;
            document.getElementById('fin-expense').innerText = `R$ ${exp.toFixed(2)}`;
        }
        function addTransaction() {
            const desc = document.getElementById('trans-desc').value;
            const val = document.getElementById('trans-value').value;
            if(desc && val) {
                data.transactions.push({id:Date.now(), type:document.getElementById('trans-type').value, desc, amount:val, category:document.getElementById('trans-cat').value||'Geral', date:new Date().toISOString()});
                saveData(); closeModal('transaction-modal');
            }
        }
        function delTrans(id) { if(confirm('Excluir?')) { data.transactions = data.transactions.filter(t=>t.id!==id); saveData(); } }

        // --- UTILS ICS ---
        function formatDateForICS(dateStr, timeStr) {
            const cleanDate = dateStr.replace(/-/g, '');
            const cleanTime = timeStr.replace(/:/g, '') + '00';
            return `${cleanDate}T${cleanTime}`;
        }

        function downloadICS(title, date, start, end) {
            let endTime = end;
            if(!endTime) {
                const [h, m] = start.split(':').map(Number);
                const endH = (h + 1).toString().padStart(2, '0');
                endTime = `${endH}:${m}`;
            }

            const startFormatted = formatDateForICS(date, start);
            const endFormatted = formatDateForICS(date, endTime);

            const icsMsg = 
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Meu Planejamento//PT
BEGIN:VEVENT
UID:${Date.now()}@meuplanejamento.com
DTSTAMP:${startFormatted}Z
DTSTART:${startFormatted}
DTEND:${endFormatted}
SUMMARY:${title}
DESCRIPTION:Evento criado via Meu Planejamento
BEGIN:VALARM
TRIGGER:-PT10M
ACTION:DISPLAY
DESCRIPTION:Lembrete
END:VALARM
END:VEVENT
END:VCALENDAR`;

            const blob = new Blob([icsMsg], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.setAttribute('download', 'evento.ics');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function checkNotifications() {
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            const nowMins = now.getHours() * 60 + now.getMinutes();
            data.events.forEach(e => {
                if(e.dateString === todayStr && !e.completed) {
                    const [h, m] = e.time.split(':').map(Number);
                    if((h*60 + m) - nowMins === 10) showToast(`üîî ${e.title} em 10 min`);
                }
            });
        }
        function showToast(msg) {
            const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('visible');
            setTimeout(()=>t.classList.remove('visible'), 3000);
        }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        window.onclick = e => { if(e.target.classList.contains('modal')) e.target.style.display='none'; }
    </script>
</body>
</html>
